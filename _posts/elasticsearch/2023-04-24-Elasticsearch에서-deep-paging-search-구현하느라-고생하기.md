---
layout: post
title: Elasticsearch에서 deep paging search 구현하느라 고생하기
tags: [elasticsearch]
skills: [elasticsearch]
author: mainmethod0126
excerpt_separator: <!--more-->
---

## Deep Paging Search 란

인터넷을 하다보면 이런 화면을 여럿 보셨을 겁니다.
![picture 1](../../images/7d267196895c1945f7f821d2b448533a9893b28fde960760fd51d10effa64e9b.png)  
![picture 2](../../images/ed53fa1a67db903d90e9153d8b09c296d73707ff1e037dbe41acca801a1e867a.png)  

화살표를 통하여 현재 보고있는 페이지를 이동하는 것, 우측으로 갈 수록 점점 높은 숫자의 페이지로 이동하고 보고자 하는 내용은 더 오래된, 더 내가 원하는 내용과는 거리가 먼 그런 데이터가 노출되는 페이지로 이동하게 됩니다.

페이지를 우측으로 이동할 수록 더 깊숙히 있는 정보를 조회하는 느낌이 듭니다.
단순 10의 자리 많아야 100의 자리 페이지를 조회하는데는 큰 문제가 없을 수 있습니다.

하지만 만약 **9999999 번째 페이지** 를 조회하면 어떻게 될까요?

만약 이 페이징의 기준이 **데이터가 적재된 순서** 라고 하면 서버는 **1~9999999번 째 페이지에 해당하는 모든 정보를 데이터가 적재된 순서로 정렬해야합니다.**

그래야 가장 최근에 적재된 데이터를 1번 페이지로, 가장 오래전에 적재된 데이터를 9999999 페이지로 보여줄 수 있겠죠.

한 페이지에 10개의 데이터를 보여준다고 했을 때 대략 **구천만개 이상**의 데이터를 정렬해야합니다.

검색을 시도한 사용자에게 페이징 기능을 제공하기 위해서는 **최소한 한번의 정렬** 은 이뤄저야합니다.

여기서 잠시 페이징 검색의 요구사항을 하나 짚어보겠습니다

- **첫 조회 후 페이징된 데이터는 실시간으로 변하면 안된다.**

만약 사용자가 **"치킨"** 이라는 키워드를 검색하였는데, 때마침 월드컵 시즌이라 순식간에 **"치킨"** 이라는 데이터가 폭발적으로 적재되었다고 가정합니다.

사용자가 검색했을 때 페이지가 총 **5페이지** 였는데 **1번 부터 5번 페이지** 까지 이동하는 동안 페이지가 계속 늘어나서 순식간에 **9999999 번째 페이지가 생성되었습니다**

그럼 이 데이터 역시 **데이터가 적재된 순서**에 따른 페이징이라면, 방금전까지 보고있던 5번 페이지의 데이터가 뒤로 쭉쭉 밀려 9999999번째 페이지까지 이동 될 겁니다.

그러면 사용자는 **"어라? 5번 페이지에서 봤던 내용이 또 나오네?"** 라는 불편을 겪게되겠죠.

그렇기 때문에 페이징 검색의 경우 재검색을 시도하지 않을 때는 페이징된 내용이 유지되어야 합니다. 실제로 데이터가 실시간으로 추가된다 하더라도 이미 검색되어진 정보는 유지되어야하죠

즉 사용자가 검색을 시도한 시점의 검색 결과를 어딘가에 **캐싱**해둬야한다는 말 입니다.

이때 Elasticsearch에서는 문제가 발생하는데, RDBMS와 비교를 통해 알아보겠습니다.

## RDBMS VS Elasticsearch

그럼 저렇게 Deep한 페이징을 시도하는 많은 시스템들이 **캐싱**을 진행하고 있고, 수 많은 데이터를 캐싱하는 것은 굉장히 부담된 현상이며 시스템 문제를 발생시킬 가능성이 매우 높습니다.

그런데 딱히 문제를 일으키는 경우를 본적이 없는 것 같습니다

왜 그럴까요?

### RDBMS

보통 저런 Deep한 페이징(9999999번째 페이지를 보여줘야하는)을 하는 서비스의 경우 데이터를 DB를 RDBMS(Mariadb, mssql 등) 을 사용합니다.

단순하게 생각해보면 이 **RDBMS** 도 결국은 **캐싱**을 피해갈 수 없을텐대 왜 문제가 발생하지 않을까요?

가장 큰 이유는 **디스크상의 파일로 정렬을 사용한다** 입니다.







## Elasticsearch Deep Paging Search 해도 되는건가?

Elasticsearch에서 깊은 검색을 해보신분이라면 저와 같은 의문을 느껴보신 분이 계실겁니다.

**"이렇게 해도 되는건가?"**

### 일단 결론

Deep Paging Search 를 하지 말자!

왜 이런 결론이 나왔는지를 이제부터 저의 경험을 예시로 설명드리겠습니다.



